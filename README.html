<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><style>body {
  max-width: 980px;
  border: 1px solid #ddd;
  outline: 1300px solid #fff;
  margin: 16px auto;
}

body .markdown-body
{
  padding: 45px;
}

@font-face {
  font-family: fontawesome-mini;
  src: url(data:font/woff;charset=utf-8;base64,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) format('woff');
}

.markdown-body {
  font-family: sans-serif;
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  color: #333333;
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body b,
.markdown-body strong {
  font-weight: bold;
}

.markdown-body mark {
  background: #ff0;
  color: #000;
  font-style: italic;
  font-weight: bold;
}

.markdown-body sub,
.markdown-body sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
.markdown-body sup {
  top: -0.5em;
}
.markdown-body sub {
  bottom: -0.25em;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre,
.markdown-body samp {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body .codehilitetable,
.markdown-body .highlighttable {
  border: 0;
  border-spacing: 0;
}

.markdown-body .codehilitetable tr,
.markdown-body .highlighttable {
  border: 0;
}

.markdown-body .codehilitetable pre,
.markdown-body .codehilitetable div.codehilite,
.markdown-body .highlighttable pre,
.markdown-body .highlighttable div.highlight {
  margin: 0;
}

.markdown-body .linenos,
.markdown-body .code,
.markdown-body .codehilitetable td,
.markdown-body .highlighttable td {
  border: 0;
  padding: 0;
}

.markdown-body td:not(.linenos) .linenodiv {
  padding: 0 !important;
}

.markdown-body .code {
  width: 100%;
}

.markdown-body .linenos div pre,
.markdown-body .linenodiv pre,
.markdown-body .linenodiv {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-left-radius: 3px;
  -webkit-border-bottom-left-radius: 3px;
  -moz-border-radius-topleft: 3px;
  -moz-border-radius-bottomleft: 3px;
  border-top-left-radius: 3px;
  border-bottom-left-radius: 3px;
}

.markdown-body .code div pre,
.markdown-body .code div {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-right-radius: 3px;
  -webkit-border-bottom-right-radius: 3px;
  -moz-border-radius-topright: 3px;
  -moz-border-radius-bottomright: 3px;
  border-top-right-radius: 3px;
  border-bottom-right-radius: 3px;
}

.markdown-body * {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body input {
  font: 13px Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
  line-height: 1.4;
}

.markdown-body a {
  color: #4183c4;
  text-decoration: none;
}

.markdown-body a:hover,
.markdown-body a:focus,
.markdown-body a:active {
  text-decoration: underline;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #ddd;
}

.markdown-body hr:before,
.markdown-body hr:after {
  display: table;
  content: " ";
}

.markdown-body hr:after {
  clear: both;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code,
.markdown-body pre,
.markdown-body samp {
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 12px;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body kbd {
  background-color: #e7e7e7;
  background-image: -moz-linear-gradient(#fefefe, #e7e7e7);
  background-image: -webkit-linear-gradient(#fefefe, #e7e7e7);
  background-image: linear-gradient(#fefefe, #e7e7e7);
  background-repeat: repeat-x;
  border-radius: 2px;
  border: 1px solid #cfcfcf;
  color: #000;
  padding: 3px 5px;
  line-height: 10px;
  font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
  display: inline-block;
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body .headerlink {
  font: normal 400 16px fontawesome-mini;
  vertical-align: middle;
  margin-left: -16px;
  float: left;
  display: inline-block;
  text-decoration: none;
  opacity: 0;
  color: #333;
}

.markdown-body .headerlink:focus {
  outline: none;
}

.markdown-body h1 .headerlink {
  margin-top: 0.8rem;
}

.markdown-body h2 .headerlink,
.markdown-body h3 .headerlink {
  margin-top: 0.6rem;
}

.markdown-body h4 .headerlink {
  margin-top: 0.2rem;
}

.markdown-body h5 .headerlink,
.markdown-body h6 .headerlink {
  margin-top: 0;
}

.markdown-body .headerlink:hover,
.markdown-body h1:hover .headerlink,
.markdown-body h2:hover .headerlink,
.markdown-body h3:hover .headerlink,
.markdown-body h4:hover .headerlink,
.markdown-body h5:hover .headerlink,
.markdown-body h6:hover .headerlink {
  opacity: 1;
  text-decoration: none;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h6 {
  font-size: 1em;
  color: #777;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre,
.markdown-body .admonition {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

.markdown-body img {
  max-width: 100%;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body code,
.markdown-body samp {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0,0,0,0.04);
  border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .codehilite,
.markdown-body .highlight {
  margin-bottom: 16px;
}

.markdown-body .codehilite pre,
.markdown-body .highlight pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}

.markdown-body .codehilite pre,
.markdown-body .highlight pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after {
  content: normal;
}

/* Admonition */
.markdown-body .admonition {
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  position: relative;
  border-radius: 3px;
  border: 1px solid #e0e0e0;
  border-left: 6px solid #333;
  padding: 10px 10px 10px 30px;
}

.markdown-body .admonition table {
  color: #333;
}

.markdown-body .admonition p {
  padding: 0;
}

.markdown-body .admonition-title {
  font-weight: bold;
  margin: 0;
}

.markdown-body .admonition>.admonition-title {
  color: #333;
}

.markdown-body .attention>.admonition-title {
  color: #a6d796;
}

.markdown-body .caution>.admonition-title {
  color: #d7a796;
}

.markdown-body .hint>.admonition-title {
  color: #96c6d7;
}

.markdown-body .danger>.admonition-title {
  color: #c25f77;
}

.markdown-body .question>.admonition-title {
  color: #96a6d7;
}

.markdown-body .note>.admonition-title {
  color: #d7c896;
}

.markdown-body .admonition:before,
.markdown-body .attention:before,
.markdown-body .caution:before,
.markdown-body .hint:before,
.markdown-body .danger:before,
.markdown-body .question:before,
.markdown-body .note:before {
  font: normal normal 16px fontawesome-mini;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  line-height: 1.5;
  color: #333;
  position: absolute;
  left: 0;
  top: 0;
  padding-top: 10px;
  padding-left: 10px;
}

.markdown-body .admonition:before {
  content: "\f056\00a0";
  color: 333;
}

.markdown-body .attention:before {
  content: "\f058\00a0";
  color: #a6d796;
}

.markdown-body .caution:before {
  content: "\f06a\00a0";
  color: #d7a796;
}

.markdown-body .hint:before {
  content: "\f05a\00a0";
  color: #96c6d7;
}

.markdown-body .danger:before {
  content: "\f057\00a0";
  color: #c25f77;
}

.markdown-body .question:before {
  content: "\f059\00a0";
  color: #96a6d7;
}

.markdown-body .note:before {
  content: "\f040\00a0";
  color: #d7c896;
}

.markdown-body .admonition::after {
  content: normal;
}

.markdown-body .attention {
  border-left: 6px solid #a6d796;
}

.markdown-body .caution {
  border-left: 6px solid #d7a796;
}

.markdown-body .hint {
  border-left: 6px solid #96c6d7;
}

.markdown-body .danger {
  border-left: 6px solid #c25f77;
}

.markdown-body .question {
  border-left: 6px solid #96a6d7;
}

.markdown-body .note {
  border-left: 6px solid #d7c896;
}

.markdown-body .admonition>*:first-child {
  margin-top: 0 !important;
}

.markdown-body .admonition>*:last-child {
  margin-bottom: 0 !important;
}

/* progress bar*/
.markdown-body .progress {
  display: block;
  width: 300px;
  margin: 10px 0;
  height: 24px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #ededed;
  position: relative;
  box-shadow: inset -1px 1px 3px rgba(0, 0, 0, .1);
}

.markdown-body .progress-label {
  position: absolute;
  text-align: center;
  font-weight: bold;
  width: 100%; margin: 0;
  line-height: 24px;
  color: #333;
  text-shadow: 1px 1px 0 #fefefe, -1px -1px 0 #fefefe, -1px 1px 0 #fefefe, 1px -1px 0 #fefefe, 0 1px 0 #fefefe, 0 -1px 0 #fefefe, 1px 0 0 #fefefe, -1px 0 0 #fefefe, 1px 1px 2px #000;
  -webkit-font-smoothing: antialiased !important;
  white-space: nowrap;
  overflow: hidden;
}

.markdown-body .progress-bar {
  height: 24px;
  float: left;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #96c6d7;
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, .5), inset 0 -1px 0 rgba(0, 0, 0, .1);
  background-size: 30px 30px;
  background-image: -webkit-linear-gradient(
    135deg, rgba(255, 255, 255, .4) 27%,
    transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%,
    transparent 77%, transparent
  );
  background-image: -moz-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -ms-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -o-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
}

.markdown-body .progress-100plus .progress-bar {
  background-color: #a6d796;
}

.markdown-body .progress-80plus .progress-bar {
  background-color: #c6d796;
}

.markdown-body .progress-60plus .progress-bar {
  background-color: #d7c896;
}

.markdown-body .progress-40plus .progress-bar {
  background-color: #d7a796;
}

.markdown-body .progress-20plus .progress-bar {
  background-color: #d796a6;
}

.markdown-body .progress-0plus .progress-bar {
  background-color: #c25f77;
}

.markdown-body .candystripe-animate .progress-bar{
  -webkit-animation: animate-stripes 3s linear infinite;
  -moz-animation: animate-stripes 3s linear infinite;
  animation: animate-stripes 3s linear infinite;
}

@-webkit-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@-moz-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

.markdown-body .gloss .progress-bar {
  box-shadow:
    inset 0 4px 12px rgba(255, 255, 255, .7),
    inset 0 -12px 0 rgba(0, 0, 0, .05);
}

/* MultiMarkdown Critic Blocks */
.markdown-body .critic_mark {
  background: #ff0;
}

.markdown-body .critic_delete {
  color: #c82829;
  text-decoration: line-through;
}

.markdown-body .critic_insert {
  color: #718c00 ;
  text-decoration: underline;
}

.markdown-body .critic_comment {
  color: #8e908c;
  font-style: italic;
}

.markdown-body .headeranchor {
  font: normal normal 16px fontawesome-mini;
  line-height: 1;
  display: inline-block;
  text-decoration: none;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.headeranchor:before {
  content: '\e157';
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  margin: 0 4px 0.25em -20px;
  vertical-align: middle;
}

/* Media */
@media only screen and (min-width: 480px) {
  .markdown-body {
    font-size:14px;
  }
}

@media only screen and (min-width: 768px) {
  .markdown-body {
    font-size:16px;
  }
}

@media print {
  .markdown-body * {
    background: transparent !important;
    color: black !important;
    filter:none !important;
    -ms-filter: none !important;
  }

  .markdown-body {
    font-size:12pt;
    max-width:100%;
    outline:none;
    border: 0;
  }

  .markdown-body a,
  .markdown-body a:visited {
    text-decoration: underline;
  }

  .markdown-body .headeranchor-link {
    display: none;
  }

  .markdown-body a[href]:after {
    content: " (" attr(href) ")";
  }

  .markdown-body abbr[title]:after {
    content: " (" attr(title) ")";
  }

  .markdown-body .ir a:after,
  .markdown-body a[href^="javascript:"]:after,
  .markdown-body a[href^="#"]:after {
    content: "";
  }

  .markdown-body pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .markdown-body pre,
  .markdown-body blockquote {
    border: 1px solid #999;
    padding-right: 1em;
    page-break-inside: avoid;
  }

  .markdown-body .progress,
  .markdown-body .progress-bar {
    -moz-box-shadow: none;
    -webkit-box-shadow: none;
    box-shadow: none;
  }

  .markdown-body .progress {
    border: 1px solid #ddd;
  }

  .markdown-body .progress-bar {
    height: 22px;
    border-right: 1px solid #ddd;
  }

  .markdown-body tr,
  .markdown-body img {
    page-break-inside: avoid;
  }

  .markdown-body img {
    max-width: 100% !important;
  }

  .markdown-body p,
  .markdown-body h2,
  .markdown-body h3 {
    orphans: 3;
    widows: 3;
  }

  .markdown-body h2,
  .markdown-body h3 {
    page-break-after: avoid;
  }
}
</style><style>/*GitHub*/
.highlight {background-color:#fff;color:#333333;}
.highlight .hll {background-color:#ffffcc;}
.highlight .c{color:#999988;font-style:italic}
.highlight .err{color:#a61717;background-color:#e3d2d2}
.highlight .k{font-weight:bold}
.highlight .o{font-weight:bold}
.highlight .cm{color:#999988;font-style:italic}
.highlight .cp{color:#999999;font-weight:bold}
.highlight .c1{color:#999988;font-style:italic}
.highlight .cs{color:#999999;font-weight:bold;font-style:italic}
.highlight .gd{color:#000000;background-color:#ffdddd}
.highlight .ge{font-style:italic}
.highlight .gr{color:#aa0000}
.highlight .gh{color:#999999}
.highlight .gi{color:#000000;background-color:#ddffdd}
.highlight .go{color:#888888}
.highlight .gp{color:#555555}
.highlight .gs{font-weight:bold}
.highlight .gu{color:#800080;font-weight:bold}
.highlight .gt{color:#aa0000}
.highlight .kc{font-weight:bold}
.highlight .kd{font-weight:bold}
.highlight .kn{font-weight:bold}
.highlight .kp{font-weight:bold}
.highlight .kr{font-weight:bold}
.highlight .kt{color:#445588;font-weight:bold}
.highlight .m{color:#009999}
.highlight .s{color:#dd1144}
.highlight .n{color:#333333}
.highlight .na{color:teal}
.highlight .nb{color:#0086b3}
.highlight .nc{color:#445588;font-weight:bold}
.highlight .no{color:teal}
.highlight .ni{color:purple}
.highlight .ne{color:#990000;font-weight:bold}
.highlight .nf{color:#990000;font-weight:bold}
.highlight .nn{color:#555555}
.highlight .nt{color:navy}
.highlight .nv{color:teal}
.highlight .ow{font-weight:bold}
.highlight .w{color:#bbbbbb}
.highlight .mf{color:#009999}
.highlight .mh{color:#009999}
.highlight .mi{color:#009999}
.highlight .mo{color:#009999}
.highlight .sb{color:#dd1144}
.highlight .sc{color:#dd1144}
.highlight .sd{color:#dd1144}
.highlight .s2{color:#dd1144}
.highlight .se{color:#dd1144}
.highlight .sh{color:#dd1144}
.highlight .si{color:#dd1144}
.highlight .sx{color:#dd1144}
.highlight .sr{color:#009926}
.highlight .s1{color:#dd1144}
.highlight .ss{color:#990073}
.highlight .bp{color:#999999}
.highlight .vc{color:teal}
.highlight .vg{color:teal}
.highlight .vi{color:teal}
.highlight .il{color:#009999}
.highlight .gc{color:#999;background-color:#EAF2F5}
</style><title>README</title></head><body><article class="markdown-body"><h1 id="concurrent-bikes">Concurrent Bikes<a class="headerlink" href="#concurrent-bikes" title="Permanent link"></a></h1>
<p>The aim of this project is to test the new async/await and concurrency features introduced in Swift 5.5.</p>
<h2 id="citybike">CityBike 🌎<a class="headerlink" href="#citybike" title="Permanent link"></a></h2>
<p>Real time information about bike stations in cities all around the world can be requested for free thanks to <a href="http://api.citybik.es/v2/">CityBike API</a>.</p>
<h2 id="simulation">Simulation 🤖<a class="headerlink" href="#simulation" title="Permanent link"></a></h2>
<p>This iOS project will simulate how a certain number of bicycle users travel by bike across the city, from one bike station to another.</p>
<h3 id="arrives-to-a-station-walking">Arrives to a station walking 👣<a class="headerlink" href="#arrives-to-a-station-walking" title="Permanent link"></a></h3>
<p>At the beginning of the simulation, no user has a bike so they all have to go (walking) to a station to collect one.</p>
<h6 id="possible-scenarios">Possible scenarios<a class="headerlink" href="#possible-scenarios" title="Permanent link"></a></h6>
<p>✅ There are bikes available. So it takes the bike and moves to the next station to leave it.</p>
<p>⛔️ There are no bikes available in this station. So it moves to the next station (walking) to see if there are available bikes there.</p>
<h3 id="arrives-to-a-station-by-bike">Arrives to a station by bike 🚲<a class="headerlink" href="#arrives-to-a-station-by-bike" title="Permanent link"></a></h3>
<p>When the user arrives to a station by bike, it has to leave it so that others can use it.</p>
<h6 id="possible-scenarios_1">Possible scenarios<a class="headerlink" href="#possible-scenarios_1" title="Permanent link"></a></h6>
<p>✅ There are empty slots. So it can leave the bike and move walking to the next station.</p>
<p>⛔️ There are no empty slots in this station. So it moves to the next station (cycling) to see if there are empty slots there.</p>
<h3 id="goal">Goal 🏁<a class="headerlink" href="#goal" title="Permanent link"></a></h3>
<p>A goal station can be set for an user and a maximum number of attempts to reach its target (leave a bike in this station).</p>
<p>If the goal is reached, the simulation finishes for that user, otherwise, it will continue until the maximum number of attempts is reached.</p>
<p>The number of attempts is increased everytime the user arrives cycling to a station (arriving on foot doesn&rsquo;t count) and there is an empty space so it can leave its bike.</p>
<h3 id="time">Time ⏳<a class="headerlink" href="#time" title="Permanent link"></a></h3>
<p>Moving from one station to another takes time and this time will have a different consideration depending on the user&rsquo;s activity.</p>
<h6 id="waiting-time">Waiting time<a class="headerlink" href="#waiting-time" title="Permanent link"></a></h6>
<p>When the user has to move to another station because there are not bikes available to take or (if it already has a bike) there are no empty spaces to leave its bike, this will be considered waiting time.</p>
<h6 id="normal-time">Normal time<a class="headerlink" href="#normal-time" title="Permanent link"></a></h6>
<p>When the user is moving walking or cycling to a station to leave or take a bike (not because it could not do this in the previous station), this will be considered normal time.</p>
<h3 id="randomness">Randomness 🎲<a class="headerlink" href="#randomness" title="Permanent link"></a></h3>
<p>The next station will always be chosen randomly. In fact, the next station can be the station in which the user already is and the time to reach any station (even the one in which the user already is) is always the same.</p>
<p>The aim of this project is not to create a great and realistic simulation, its only purpose is to generate a simple situation to which the new async/await and concurrency features can be applied.</p>
<h2 id="concurrency">Concurrency 🧵<a class="headerlink" href="#concurrency" title="Permanent link"></a></h2>
<p>This would not be funny with only one user travelling through the city, this is why multiple users will run their individual simulations simultaneously, using the same stations, fighting to take bikes and to find empty slots.</p>
<h6 id="no-conflict">No conflict<a class="headerlink" href="#no-conflict" title="Permanent link"></a></h6>
<p>In a simulation with only one station and more bikes than users, there will never be conflicts. Because the station will always have a bike or an empty space to offer.</p>
<h6 id="conflict">Conflict<a class="headerlink" href="#conflict" title="Permanent link"></a></h6>
<p>Two or more users arrive walking or cycling to a station with not enough bikes or empty slots for everybody, some will have to move to the next station (waiting time for that users).</p>
<h3 id="race-conditions">Race conditions 🏎<a class="headerlink" href="#race-conditions" title="Permanent link"></a></h3>
<p>Users cannot communicate to each other, they can only communicate with the station and this will tell them if they can take/leave a bike, or if they will have to try their luck in the next station.</p>
<p>So its impossible for them to reach an agreement and pass the bicycle to each other without having to park it and pick it up.</p>
<p>The station will handle this transaction, in which the order of arrival matters little, the bike or empty slot may be conferred to a newcomer rather than to an user that has been waiting for an hour.</p>
<p>In order to the number of free bikes and empty slots to remain consistent, all the take bike / leave bike operations for each user must be done atomically.</p>
<h6 id="take-bike-atomic-operation">Take bike atomic operation<a class="headerlink" href="#take-bike-atomic-operation" title="Permanent link"></a></h6>
<p>Check if there is any free bike and if there is, decrement the number of free bikes in the station and increment the number of empty slots in the station.</p>
<h6 id="leave-bike-atomic-operation">Leave bike atomic operation<a class="headerlink" href="#leave-bike-atomic-operation" title="Permanent link"></a></h6>
<p>Check if there is any empty slot and if there is, decrement the number of empty slots in the station and increment the number of free bikes in the station.</p>
<h4 id="what-could-happen-without-atomicity">What could happen without atomicity? ⚛️<a class="headerlink" href="#what-could-happen-without-atomicity" title="Permanent link"></a></h4>
<p>Two users (A and B) could arrive cycling to a station with only one empty slot and both would want to leave their bikes.</p>
<p>As every user is independent from each other, without atomicity, the sequence of events could be as follows:</p>
<ol>
<li>User A asks the station if it has empty slots available. </li>
<li>The station says yes.</li>
<li>User B asks the station if it has empty slots available.</li>
<li>The station says yes.</li>
<li>The station&rsquo;s number of slots available drops down to 0 due to user B.</li>
<li>The station&rsquo;s number of slots available drops down again to -1 due to user A.</li>
</ol>
<p>There can not be -1 empty slots, this is an incorrect state for the bike station and to avoid it, events 1, 2 and 6 should not have been interspersed with events 3, 4 and 5.</p>
<p>Note that the user A asks first to the station but the station answers first to B. This has been done on purpose to emphasize that the order of arrival doesn&rsquo;t matter to the station.</p>
<h2 id="implementation">Implementation ⚒️<a class="headerlink" href="#implementation" title="Permanent link"></a></h2>
<p>Async/await and structured concurrency features have been applied to all the steps of the development: service, model, mocking, testing and of course the simulation itself.</p>
<h3 id="data-collection">Data collection 📡<a class="headerlink" href="#data-collection" title="Permanent link"></a></h3>
<p>Realistic data about bike stations can be obtained from <a href="http://api.citybik.es/v2/">CityBike API</a> but it can also be mocked to make testing easier, faster and more reliable.</p>
<h6 id="protocol-witness">Protocol witness<a class="headerlink" href="#protocol-witness" title="Permanent link"></a></h6>
<p>In fact, the app doesn&rsquo;t care where the data comes from, its a great idea using a protocol witness to abstract data collection leveraging all the power of generics.</p>
<div class="highlight"><pre><span class="c1">/// Generic protocol witness to abstract data collection.</span>
<span class="kd">struct</span> <span class="nc">Service</span><span class="p">&lt;</span><span class="n">T</span><span class="p">:</span> <span class="n">Decodable</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="c1">/// Use this completion handler to return asynchronously the data requested.</span>
    <span class="kd">let</span> <span class="nv">get</span><span class="p">:</span> <span class="p">()</span> <span class="n">async</span> <span class="p">-&gt;</span> <span class="n">T</span><span class="p">?</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="nc">Service</span> <span class="p">{</span>

    <span class="c1">/// Obtains data from a json file.</span>
    <span class="c1">/// - Parameters:</span>
    <span class="c1">///   - jsonFileName: The name of this file without extension.</span>
    <span class="c1">///   - bundle: The bundle in which the file is located.</span>
    <span class="c1">/// - Returns: Returns the decoded data.</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">get</span><span class="p">(</span><span class="n">from</span> <span class="n">jsonFileName</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">bundle</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">)</span> <span class="n">throws</span> <span class="p">-&gt;</span> <span class="kc">Self</span> <span class="p">{</span>
        <span class="c1">// Look for the file, throw an error if the file is missing.</span>
        <span class="n">guard</span> <span class="kd">let</span> <span class="nv">url</span> <span class="p">=</span> <span class="n">bundle</span><span class="p">.</span><span class="n">url</span><span class="p">(</span><span class="n">forResource</span><span class="p">:</span> <span class="n">jsonFileName</span><span class="p">,</span> <span class="n">withExtension</span><span class="p">:</span> <span class="s">&quot;json&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">throw</span> <span class="n">ServiceError</span><span class="p">.</span><span class="n">missingFile</span><span class="p">(</span><span class="s">&quot;</span><span class="si">\(</span><span class="n">jsonFileName</span><span class="si">)</span><span class="s">.json&quot;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="c1">// Convert file to Data. Force unwrap makes sense because if the file exists,</span>
        <span class="c1">// the data can&#39;t be nil.</span>
        <span class="kd">let</span> <span class="nv">data</span><span class="p">:</span> <span class="n">Data</span> <span class="p">=</span> <span class="n">try</span><span class="p">!</span> <span class="n">Data</span><span class="p">(</span><span class="n">contentsOf</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
        <span class="c1">// Decode data, throw a DecodingError if there is a problem.</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nv">decoded</span> <span class="p">=</span> <span class="n">try</span> <span class="n">JSONDecoder</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="n">T</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">from</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="kr">get</span><span class="p">:</span> <span class="p">{</span> <span class="n">decoded</span> <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">/// Obtains data from an URL using shared URLSession.</span>
    <span class="c1">/// - Parameter url: The URL from which the data will be requested.</span>
    <span class="c1">/// - Returns: Returns de decoded data.</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">get</span><span class="p">(</span><span class="n">from</span> <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">)</span> <span class="n">async</span> <span class="n">throws</span> <span class="p">-&gt;</span> <span class="kc">Self</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="kc">_</span><span class="p">)</span> <span class="p">=</span> <span class="n">try</span> <span class="n">await</span> <span class="n">URLSession</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">data</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
        <span class="kd">let</span> <span class="nv">decoded</span> <span class="p">=</span> <span class="n">try</span> <span class="n">JSONDecoder</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="n">T</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">from</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="kr">get</span><span class="p">:</span> <span class="p">{</span> <span class="n">decoded</span> <span class="p">})</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>In the <code>get(from url: URL)</code> function and the protocol witness&rsquo; closure <code>let get: () async -&gt; T?</code>, the first outbreaks of async/await can be seen.</p>
<p>Thanks to generics, this protocol witness can be reused to collect asynchronously any kind of <code>Decodable</code> data from different sources.</p>
<div class="highlight"><pre><span class="c1">// Obtains whatever decodable object from an URL.</span>
<span class="kd">let</span> <span class="nv">whateverDecodable</span> <span class="p">=</span> <span class="n">try</span> <span class="n">await</span> <span class="n">Service</span><span class="p">&lt;</span><span class="n">WhateverDecodable</span><span class="p">&gt;.</span><span class="kr">get</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">).</span><span class="kr">get</span><span class="p">()</span>
</pre></div>

<div class="highlight"><pre><span class="c1">// Obtains whatever decodable object from a JSON file.</span>
<span class="kd">let</span> <span class="nv">whateverDecodable</span> <span class="p">=</span> <span class="n">try</span> <span class="n">await</span> <span class="n">Service</span><span class="p">&lt;</span><span class="n">WhateverDecodable</span><span class="p">&gt;.</span><span class="kr">get</span><span class="p">(</span>
    <span class="n">from</span><span class="p">:</span> <span class="s">&quot;JsonNameWithoutExtension&quot;</span><span class="p">,</span>
    <span class="n">bundle</span><span class="p">:</span> <span class="n">bundle</span>
<span class="p">).</span><span class="kr">get</span><span class="p">()</span>
</pre></div>

<h4 id="urlsessions-asyncawait-apis">URLSession&rsquo;s async/await APIs 🌐<a class="headerlink" href="#urlsessions-asyncawait-apis" title="Permanent link"></a></h4>
<p>The typical approach of data fetching with <code>URLSession</code> is using completion handlers.</p>
<div class="highlight"><pre><span class="n">URLSession</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">dataTask</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span> <span class="p">{</span> <span class="n">data</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
    <span class="c1">// Code here will run when the async operation finishes.</span>
<span class="p">}</span>
</pre></div>

<p>This solution adds an undesirable identation level for each data task. If there are more requests to be made after the first one and each one depends on the result of its predecessor, they would have to be put one inside the other and the result would be cumbersome with so many unpleasant identation levels.</p>
<div class="highlight"><pre><span class="n">URLSession</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">dataTask</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span> <span class="p">{</span> <span class="kc">_</span><span class="p">,</span> <span class="kc">_</span><span class="p">,</span> <span class="kc">_</span> <span class="k">in</span>
    <span class="n">URLSession</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">dataTask</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span> <span class="p">{</span> <span class="kc">_</span><span class="p">,</span> <span class="kc">_</span><span class="p">,</span> <span class="kc">_</span> <span class="k">in</span>
        <span class="n">URLSession</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">dataTask</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span> <span class="p">{</span> <span class="kc">_</span><span class="p">,</span> <span class="kc">_</span><span class="p">,</span> <span class="kc">_</span> <span class="k">in</span>
            <span class="n">URLSession</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">dataTask</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span> <span class="p">{</span> <span class="kc">_</span><span class="p">,</span> <span class="kc">_</span><span class="p">,</span> <span class="kc">_</span> <span class="k">in</span>
                <span class="c1">// Code here will run when all the async operations finish.</span>
                <span class="c1">// ...</span>
</pre></div>

<h6 id="asyncawait">Async/await<a class="headerlink" href="#asyncawait" title="Permanent link"></a></h6>
<p>With the async/await approach, the code is run sequentially without the need of identation. When <code>let (data, _) = try await URLSession.shared.data(from: url)</code> is executed, the thread is paused and it will resume its execution in the next line when the async operation finishes.</p>
<p>The data will be available when the execution is resumed, in this case the response is not interesting so it is omitted with an <code>_</code> and the error is not collected but thrown if required.</p>
<p>Note that asynchronous functions can only be called from asynchorous contexts, so the method must be marked as <code>async</code>. As a consequence, the closure from the protocol witness has to be marked as asynchronous as well.</p>
<h4 id="test-asyncawait-functions">Test async/await functions 🚨<a class="headerlink" href="#test-asyncawait-functions" title="Permanent link"></a></h4>
<p>To test asynchronous code, <a href="https://developer.apple.com/documentation/xctest/xctestexpectation">XCTestExpectation</a> is not needed anymore.</p>
<div class="highlight"><pre><span class="kd">func</span> <span class="nf">testGetFromURL</span><span class="p">()</span> <span class="n">async</span> <span class="p">{</span>
    <span class="n">guard</span> <span class="kd">let</span> <span class="nv">url</span> <span class="p">=</span> <span class="n">URL</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="s">&quot;https://api.citybik.es/v2/networks/bikemi&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">XCTFail</span><span class="p">(</span><span class="s">&quot;Invalid URL.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">city</span> <span class="p">=</span> <span class="n">try</span> <span class="n">await</span> <span class="n">Service</span><span class="p">&lt;</span><span class="n">City</span><span class="p">&gt;.</span><span class="kr">get</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">url</span><span class="p">).</span><span class="kr">get</span><span class="p">()</span>
        <span class="n">XCTAssertEqual</span><span class="p">(</span><span class="s">&quot;bikemi&quot;</span><span class="p">,</span> <span class="n">city</span><span class="p">?.</span><span class="n">id</span><span class="p">)</span>
    <span class="p">}</span> <span class="n">catch</span> <span class="p">{</span>
        <span class="n">handleError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">testGetFromJson</span><span class="p">()</span> <span class="n">async</span> <span class="p">{</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">city</span> <span class="p">=</span> <span class="n">try</span> <span class="n">await</span> <span class="n">Service</span><span class="p">&lt;</span><span class="n">City</span><span class="p">&gt;.</span><span class="kr">get</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="s">&quot;Milano&quot;</span><span class="p">,</span> <span class="n">bundle</span><span class="p">:</span> <span class="n">bundle</span><span class="p">).</span><span class="kr">get</span><span class="p">()</span>
        <span class="n">XCTAssertEqual</span><span class="p">(</span><span class="n">city</span><span class="p">?.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;bikemi&quot;</span><span class="p">)</span>
    <span class="p">}</span> <span class="n">catch</span> <span class="p">{</span>
        <span class="n">handleError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>The test method will be paused while the asynchronous operation is running and it will resume when it finishes, whereupon the assertion will be executed as if nothing had happened.</p>
<h3 id="model">Model 💾<a class="headerlink" href="#model" title="Permanent link"></a></h3>
<p>Requesting data to the <a href="http://api.citybik.es/v2/">CityBike API</a> is completely unnecessary for this simulation (the data could just have been mocked), but it was done to try the new URLSession&rsquo;s async/await APIs.</p>
<p>Anyway, the server returns a JSON.</p>
<div class="highlight"><pre><span class="p">{</span>
    <span class="nt">&quot;network&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;company&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;ClearChannel&quot;</span>
        <span class="p">],</span>
        <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;/v2/networks/bikemi&quot;</span><span class="p">,</span>
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;bikemi&quot;</span><span class="p">,</span>
        <span class="nt">&quot;location&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;city&quot;</span><span class="p">:</span> <span class="s2">&quot;Milano&quot;</span><span class="p">,</span>
            <span class="nt">&quot;country&quot;</span><span class="p">:</span> <span class="s2">&quot;IT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">45.4654542</span><span class="p">,</span>
            <span class="nt">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">9.186516</span>
        <span class="p">},</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;BikeMi&quot;</span><span class="p">,</span>
        <span class="nt">&quot;stations&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;empty_slots&quot;</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span>
                <span class="nt">&quot;extra&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;ebikes&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="nt">&quot;has_ebikes&quot;</span><span class="p">:</span> <span class="kc">true</span>
                <span class="p">},</span>
                <span class="nt">&quot;free_bikes&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;b5262607c8a44db673b2f9acd3ddeede&quot;</span><span class="p">,</span>
                <span class="nt">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">45.464683238626</span><span class="p">,</span>
                <span class="nt">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">9.18879747390747</span><span class="p">,</span>
                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Duomo&quot;</span><span class="p">,</span>
                <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-03-04T22:58:46.228000Z&quot;</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h6 id="decodable">Decodable<a class="headerlink" href="#decodable" title="Permanent link"></a></h6>
<p>Three entities where decoded.</p>
<ul>
<li><code>Station</code> contains info about an specific bike station.</li>
<li><code>Network</code> contains info about a company that provides the service and its bike stations.</li>
<li><code>City</code> contains info about all the networks that operate in the city.</li>
</ul>
<h4 id="actors">Actors 🎭<a class="headerlink" href="#actors" title="Permanent link"></a></h4>
<p>Let&rsquo;s focus on <code>Station</code>, specifically in the properties <code>empty_slots</code> and <code>free_bikes</code>, which they are going to be modified concurrently by multiple threads.</p>
<p>Also, each station should handle the leave/take bike operations: checking if the operation can be done, increasing the number of free bikes and decreasing the number of empty slots atomically (and vice versa).</p>
<p>Swift 5.5 has introduced the concept of <code>actor</code>, a reference type that magically handles all these race conditions and atomicity.</p>
<p><div class="highlight"><pre><span class="n">actor</span> <span class="n">Station</span><span class="p">:</span> <span class="n">Decodable</span><span class="p">,</span> <span class="n">Identifiable</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">freeBikes</span><span class="p">:</span> <span class="nb">Int</span>
    <span class="kd">var</span> <span class="nv">emptySlots</span><span class="p">:</span> <span class="nb">Int</span>

    <span class="c1">// ...</span>

    <span class="kd">func</span> <span class="nf">addBike</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">freeBikes</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">emptySlots</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">removeBike</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">freeBikes</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">emptySlots</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
That&rsquo;s it, the variables (mutable state) are protected and the functions are atomic, nothing else has to be done to avoid conflicts.</p>
<p>Take a look to the proposal <a href="https://github.com/apple/swift-evolution/blob/main/proposals/0306-actors.md">SE-0306</a> to go deeper into this concept.</p>
<h3 id="run">Run 🕹<a class="headerlink" href="#run" title="Permanent link"></a></h3>
<p>Let&rsquo;s see how all this concepts work together and how the simulation was implemented.</p>
<h6 id="bikeuser">BikeUser<a class="headerlink" href="#bikeuser" title="Permanent link"></a></h6>
<p>This entity represents the user that wants to move around the city cycling and walking from one station to another, leaving and taking bikes.</p>
<p>For simplicity, just the most relevant parts of the code will be pasted here, for the complete code, check <a href="https://github.com/serg-ios/concurrent-bikes/blob/main/ConcurrentBikes/Model/BikeUser.swift">BikeUser</a>.</p>
<div class="highlight"><pre><span class="c1">/// Each user individual simulation will return the</span>
<span class="c1">/// time that the user waited and the number of times</span>
<span class="c1">/// that it travelled by bike from one station to another.</span>
<span class="kd">struct</span> <span class="nc">SimulationResult</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">time</span><span class="p">:</span> <span class="n">TimeInterval</span>
    <span class="kd">let</span> <span class="nv">paths</span><span class="p">:</span> <span class="nb">Int</span>
<span class="p">}</span>

<span class="c1">/// Identifies univocally a user.</span>
<span class="kd">var</span> <span class="nv">id</span><span class="p">:</span> <span class="nb">Int</span>

<span class="c1">/// The waiting time in nanoseconds for moving to the </span>
<span class="c1">/// next station when there are not available bikes to take</span>
<span class="c1">/// or when there are no empty slots to leave the current bike.</span>
<span class="kd">private</span> <span class="kd">let</span> <span class="nv">waitingTime</span><span class="p">:</span> <span class="nb">UInt64</span> <span class="p">=</span> <span class="mi">100_000_000</span>

<span class="c1">/// If `true`, the user is currently riding a bike.</span>
<span class="kd">private</span> <span class="kd">var</span> <span class="nv">hasBike</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">=</span> <span class="kc">false</span>

<span class="c1">/// Runs the simulation of the user moving through the area</span>
<span class="c1">/// by bike, waiting to leave or take a bike when necessary.</span>
<span class="c1">///</span>
<span class="c1">/// The task can be cancelled if the user reaches the goal </span>
<span class="c1">/// before going through all the paths.</span>
<span class="c1">///</span>
<span class="c1">/// - Parameters:</span>
<span class="c1">///</span>
<span class="c1">///   - stations: The array of stations that compounds </span>
<span class="c1">///               the area covered by the simulation.</span>
<span class="c1">///</span>
<span class="c1">///   - paths:    The number of paths that the user </span>
<span class="c1">///               must complete by bike to conclude the simulation,</span>
<span class="c1">///               unless it reaches its goal before.</span>
<span class="c1">///</span>
<span class="c1">///   - goal:     ID of the station the user wants to reach.</span>
<span class="c1">///               If `nil`, the user will run all the paths, </span>
<span class="c1">///               otherwise it will run until reaches the goal.</span>
<span class="c1">///</span>
<span class="c1">/// - Returns:    The total time in seconds waited to take or leave a bike.</span>
<span class="kd">func</span> <span class="nf">runSimulation</span><span class="p">(</span>
    <span class="k">in</span> <span class="n">stations</span><span class="p">:</span> <span class="p">[</span><span class="n">Station</span><span class="p">],</span>
    <span class="n">paths</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span>
    <span class="n">goal</span><span class="p">:</span> <span class="nb">String</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span>
<span class="p">)</span> <span class="n">async</span> <span class="p">-&gt;</span> <span class="n">SimulationResult</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">totalWaitingTime</span><span class="p">:</span> <span class="n">TimeInterval</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="kd">var</span> <span class="nv">path</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">path</span> <span class="o">&lt;</span> <span class="n">paths</span><span class="p">,</span> <span class="o">!</span><span class="n">Task</span><span class="p">.</span><span class="n">isCancelled</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">stationIndex</span> <span class="p">=</span> <span class="nb">Int</span><span class="p">.</span><span class="n">random</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="mf">0.</span><span class="p">.&lt;</span><span class="n">stations</span><span class="p">.</span><span class="bp">count</span><span class="p">)</span>
        <span class="kd">var</span> <span class="nv">station</span> <span class="p">=</span> <span class="n">stations</span><span class="p">[</span><span class="n">stationIndex</span><span class="p">]</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">hasBike</span><span class="p">,</span> <span class="n">await</span> <span class="n">station</span><span class="p">.</span><span class="n">freeBikes</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="n">await</span> <span class="n">takeBike</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">station</span><span class="p">,</span> <span class="n">logs</span><span class="p">:</span> <span class="n">logs</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">hasBike</span><span class="p">,</span> <span class="n">await</span> <span class="n">station</span><span class="p">.</span><span class="n">emptySlots</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="n">await</span> <span class="n">leaveBike</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">station</span><span class="p">,</span> <span class="n">logs</span><span class="p">:</span> <span class="n">logs</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">await</span> <span class="n">station</span><span class="p">.</span><span class="n">identifier</span> <span class="p">==</span> <span class="n">goal</span> <span class="p">{</span>
                <span class="n">withUnsafeCurrentTask</span> <span class="p">{</span> <span class="n">maybeUnsafeCurrentTask</span> <span class="k">in</span>
                    <span class="kd">let</span> <span class="nv">task</span><span class="p">:</span> <span class="n">UnsafeCurrentTask</span> <span class="p">=</span> <span class="n">maybeUnsafeCurrentTask</span><span class="p">!</span>
                    <span class="n">task</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">await</span> <span class="n">wait</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="n">station</span><span class="p">,</span> <span class="n">incrementing</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">totalWaitingTime</span><span class="p">,</span> <span class="n">logs</span><span class="p">:</span> <span class="n">logs</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">time</span><span class="p">:</span> <span class="n">totalWaitingTime</span><span class="p">,</span> <span class="n">paths</span><span class="p">:</span> <span class="n">path</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">/// Waits and increments the total waiting time.</span>
<span class="c1">///</span>
<span class="c1">/// - Parameter totalWaitingTime: Reference to the accumulated time.</span>
<span class="kd">private</span> <span class="kd">func</span> <span class="nf">wait</span><span class="p">(</span>
    <span class="n">incrementing</span> <span class="n">totalWaitingTime</span><span class="p">:</span> <span class="kr">inout</span> <span class="n">TimeInterval</span>
<span class="p">)</span> <span class="n">async</span> <span class="p">{</span>
    <span class="n">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">waitingTime</span><span class="p">)</span>
    <span class="n">totalWaitingTime</span> <span class="o">+=</span> <span class="nb">Double</span><span class="p">(</span><span class="n">waitingTime</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1_000_000_000</span>
<span class="p">}</span>

<span class="c1">/// Takes a bike from a station, leaving an empty slot.</span>
<span class="c1">///</span>
<span class="c1">/// - Parameter station: The station from which the bike will be taken.</span>
<span class="kd">private</span> <span class="kd">func</span> <span class="nf">takeBike</span><span class="p">(</span><span class="n">from</span> <span class="n">station</span><span class="p">:</span> <span class="kr">inout</span> <span class="n">Station</span><span class="p">)</span> <span class="n">async</span> <span class="p">{</span>
    <span class="n">await</span> <span class="n">station</span><span class="p">.</span><span class="n">removeBike</span><span class="p">()</span>
    <span class="n">hasBike</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="n">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">waitingTime</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">/// Leaves a bike in a station.</span>
<span class="c1">///</span>
<span class="c1">/// - Parameter station: The station in which the bike will be left.</span>
<span class="kd">private</span> <span class="kd">func</span> <span class="nf">leaveBike</span><span class="p">(</span><span class="k">in</span> <span class="n">station</span><span class="p">:</span> <span class="kr">inout</span> <span class="n">Station</span><span class="p">)</span> <span class="n">async</span> <span class="p">{</span>
    <span class="n">await</span> <span class="n">station</span><span class="p">.</span><span class="n">addBike</span><span class="p">()</span>
    <span class="n">hasBike</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="n">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">waitingTime</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

<p>The main function is <code>runSimulation(sations:paths:goal:)</code>, as it is asynchronous, it has to be marked with <code>async</code>.</p>
<ol>
<li>
<p>User arrives walking to the station and there available bikes.</p>
<p>Checking that the station has free bikes is an asynchronous operation (mutable state protected by an actor), it should be called using <code>await</code>.</p>
<p>A bike is removed from the station using the asynchronous and atomic method <code>removeBike</code>, the flag <code>hasBike</code> is activated.</p>
<p>The task goes to sleep for 0.1 seconds, simulating the travel by bike to the next station, this time is not considered waiting time because the user didn&rsquo;t have to wait to take the bike.</p>
</li>
<li>
<p>User arrives cycling to the station and there are empty slots.</p>
<p>Checking that the station has empty slots is an asynchronous operation (mutable state protected by an actor), it should be called using <code>await</code>.</p>
<p>A bike is added to the station using the asynchronous and atomic method <code>addBike</code>, the flag <code>hasBike</code> is deactivated.</p>
<p>The task goes to sleep for 0.1 seconds, simulating the travel on foot to the next station, this time is not considered waiting time because the user didn&rsquo;t have to wait to leave its bike.</p>
<p>The <code>path</code> variable is incremented, reducing the number of attempts left for the user to reach its goal.</p>
<h6 id="tasks-can-cancel-themselves">Tasks can cancel themselves<a class="headerlink" href="#tasks-can-cancel-themselves" title="Permanent link"></a></h6>
<p>Every time the user reaches cycling a station, it is checked if this is the goal station.</p>
<p>If this is the case, the task is cancelled and the user will not move to the next station, the asynchronous execution will come to an end.</p>
<p>It is safe to obtain the task from within a function marked with <code>async</code> because that function wil always be executed as an asynchronous task.</p>
<div class="highlight"><pre><span class="n">withUnsafeCurrentTask</span> <span class="p">{</span> <span class="n">maybeUnsafeCurrentTask</span> <span class="k">in</span>
    <span class="kd">let</span> <span class="nv">task</span><span class="p">:</span> <span class="n">UnsafeCurrentTask</span> <span class="p">=</span> <span class="n">maybeUnsafeCurrentTask</span><span class="p">!</span>
    <span class="n">task</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>

<p>Before trying to move to the next station, the task has to check that is has not been cancelled.</p>
<div class="highlight"><pre><span class="k">while</span> <span class="n">path</span> <span class="o">&lt;</span> <span class="n">paths</span><span class="p">,</span> <span class="o">!</span><span class="n">Task</span><span class="p">.</span><span class="n">isCancelled</span> <span class="p">{</span>
    <span class="c1">// Finish the simulation when there are not more attempts </span>
    <span class="c1">// or the goal has been reached and the task cancelled.</span>
<span class="p">}</span>
</pre></div>

</li>
<li></li>
</ol>
<!--
    This feature is evolving.
    Xcode 13 beta 4 was used.
--></article></body></html>